<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}"
>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body layout:fragment="content">

<div class="container">

<!-- 게시글 단건조회 -->
<div class="card">
  <div class="card-body">
    <h5 class="card-title"><h1 th:text="${board.title}"></h1></h5>
  <table>
  <tr>
    <td>내용</td>
    <td th:text="${board.content}"></td>
  </tr>
  <tr>
    <td>작성자</td>
    <td th:text="${board.writer}"></td>
  </tr>
  <tr>
    <td>등록일</td>
    <td th:text="${board.regdate}"></td>
  </tr>
  <tr>
    <td>업데이트일</td>
    <td th:text="${board.updatedate}"></td>
  </tr>
  <tr>
    <td>첨부파일</td>
    <td><a th:href="|/filedown/${board.attach}|" th:text="${board.attach}"></a>
        <img th:src="|/upload/${board.attach}|"></td>
  </tr>
  </table>
</div>

  
<!-- 댓글조회 -->
<div class="card mb-3">
<div class="card-body">
<h5  class="card-title">댓글목록</h5>
  <div class="replyList">
</div>

</div>


<!-- 댓글 등록 -->
	<table class="table">
		<form name="replyForm">
			<div class="row">
				<div class="col-6">
					<input name="reply" class="form-control">
				</div>
				<div class="col-3">
					<input name="replyer" class="form-control">
				</div>
				<div class="col-3">
					<input name="bno" type="hidden" class="form-control"
						th:value="${board.bno}">
				</div>
				<div class="col-3">
					<button type="button" class="btnReplyInsert">댓글저장</button>
				</div>
			</div>
		</form>
	</table>
</div> 
 

<script>
const url = "/reply";

// 등록함수실행
replyInsert();
// 댓글태그실행
replyList();
// 댓글삭제실행
replyDelete();

/*-------------------------------------
댓글 삭제 ajax 호출
---------------------------------------*/
function replyDelete(){
	document.querySelector(".replyList").addEventListener("click", function(){
		//삭제버튼이면
		if(event.target.classList.contains("btnReplyDelete")) {
			if(! confirm("삭제할까요")){
				return;
			}
			// 버튼을 포함하는 부모태그
			const div = event.target.closest(".row");
			// 삭제할 댓글번호 
			const rno = event.target.dataset.rno;
			// 서버 삭제 요청
			const url = `/replies/${rno}`;
			fetch(url, {method:"delete"})
			.then(result => result.text())
			.then(result => div.remove() )
		}
	})
}


/*-------------------------------------
댓글 조회 ajax 호출
---------------------------------------*/
function replyList(){
	const bno = replyForm.bno.value;
	const url = `/board/${bno}/reply`
	fetch( url )
	.then( result => result.json() )
	.then( result => replyListCallback(result) )
}

/*-------------------------------------
댓글 조회 콜백
---------------------------------------*/
function replyListCallback(result){
	const replys = document.querySelector(".replyList");
	replys.innerHTML = "";
	result.forEach(item => replys.insertAdjacentHTML("beforeend", replyMake(item)) );
}

/* ----------------------------------
    댓글 태그 생성
   ---------------------------------- */
function replyMake(item) {
	return `
	<div class="row border">
    <div class="col-lg-2 text-primary">${item.replyer}</div>
    <div class="col-lg-6">${item.reply}</div>
    <div class="col-lg-4"><button type="button" data-rno="${item.rno}" class="btn btn-primary btnReplyUpdateForm">수정</button>
                          <button type="button" data-rno="${item.rno}" class="btn btn-danger btnReplyDelete">삭제</button>
    </div>
</div>
`
}  
   
/*-------------------------------------
등록 버튼 이벤트 지정
---------------------------------------*/	
function replyInsert(){
	document.querySelector(".btnReplyInsert").addEventListener("click", function(){

		//파라미터 만들기
		const reply = replyForm.reply.value;
		const replyer = replyForm.replyer.value;
		const bno = replyForm.bno.value;
		const param = {reply, replyer, bno}
		
		
		//등록 요청
		fetch(url, {
			method:"post",
			headers: {
			      "Content-Type": "application/json",
			      // 'Content-Type': 'application/x-www-form-urlencoded',
			    },
			body : JSON.stringify(param), 
		})
		.then( result => result.text() )
		.then( result => alert(result) )
		//.then( result => replyList() )
	})
} 

</script>
</body>
</html>